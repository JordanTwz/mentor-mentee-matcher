name: Terraform Plan (Orchestrator)

on:
  workflow_dispatch:
    inputs:
      do_destroy:
        type: boolean
        default: false
        description: "Generate destroy plan?"
      release_stale_lock:
        type: boolean
        default: false
        description: "Allow forced unlock if lock is stale?"

jobs:
  plan:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Graphviz and Inframap
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz
          wget https://github.com/cycloidio/inframap/releases/download/v0.6.7/inframap-linux-amd64.tar.gz
          tar -xzf inframap-linux-amd64.tar.gz
          sudo mv inframap-linux-amd64 /usr/local/bin/inframap
          sudo chmod +x /usr/local/bin/inframap

      - name: AWS OIDC Auth
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::368339042148:role/asp_proj-terraform-deploy
          aws-region: ap-southeast-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.13.5"

      # ---- Init with real backend ----
      - name: Terraform Init
        working-directory: terraform
        run: terraform init -input=false

      # ---- Generate and display infrastructure map ----
      - name: Generate Infrastructure Map
        working-directory: terraform
        run: |
          inframap generate . --raw | dot -Tpng > inframap.png
          inframap generate . --raw | dot -Tsvg > inframap.svg
          echo "### Infrastructure Resource Map" >> $GITHUB_STEP_SUMMARY
          echo "![Infrastructure Map](inframap.svg)" >> $GITHUB_STEP_SUMMARY

      - name: Upload Infrastructure Map
        uses: actions/upload-artifact@v4
        with:
          name: infrastructure-map
          path: |
            terraform/inframap.png
            terraform/inframap.svg
          retention-days: 7

      # ---- Initial plan attempt ----
      - name: Terraform Plan Attempt
        id: plan
        working-directory: terraform
        continue-on-error: true
        run: |
          if [ "${{ github.event.inputs.do_destroy }}" = "true" ]; then
            terraform plan -destroy -out=tfdestroy | tee plan.log
          else
            terraform plan -out=tfplan | tee plan.log
          fi

      # ---- Detect lock conflict ----
      - name: Lock Conflict Check
        id: lockcheck
        run: |
          if grep -q "Error acquiring the state lock" terraform/plan.log; then
            echo "lock_conflict=true" >> $GITHUB_OUTPUT
          else
            echo "lock_conflict=false" >> $GITHUB_OUTPUT
          fi

      # ---- Extract lock ID (only if override selected) ----
      - name: Extract Lock ID
        if: steps.lockcheck.outputs.lock_conflict == 'true' && github.event.inputs.release_stale_lock == 'true'
        id: lock_id
        working-directory: terraform
        run: |
          LOCK_ID=$(grep -oE 'ID:[[:space:]]*[0-9a-fA-F-]{36}' plan.log | head -1 | grep -oE '[0-9a-fA-F-]{36}')
          echo "id=$LOCK_ID" >> $GITHUB_OUTPUT

      # ---- Force unlock stale lock ----
      - name: Force Unlock
        if: steps.lockcheck.outputs.lock_conflict == 'true' && github.event.inputs.release_stale_lock == 'true'
        working-directory: terraform
        run: terraform force-unlock -force ${{ steps.lock_id.outputs.id }}

      # ---- Retry plan ----
      - name: Terraform Plan Retry
        if: steps.lockcheck.outputs.lock_conflict == 'true' && github.event.inputs.release_stale_lock == 'true'
        working-directory: terraform
        run: |
          if [ "${{ github.event.inputs.do_destroy }}" = "true" ]; then
            terraform plan -destroy -out=tfdestroy
          else
            terraform plan -out=tfplan
          fi

      # ---- Fail if plan failed and lock not released ----
      - name: Check Plan Success
        if: steps.plan.outcome == 'failure' && (steps.lockcheck.outputs.lock_conflict != 'true' || github.event.inputs.release_stale_lock != 'true')
        run: |
          echo "Plan failed and lock was not released"
          exit 1

      # ---- Upload plan artifact ----
      - name: Upload Plan
        if: steps.plan.outcome == 'success' || (steps.lockcheck.outputs.lock_conflict == 'true' && github.event.inputs.release_stale_lock == 'true')
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.do_destroy == 'true' && 'terraform-destroy-plan' || 'terraform-plan' }}
          path: terraform/${{ github.event.inputs.do_destroy == 'true' && 'tfdestroy' || 'tfplan' }}
          retention-days: 7

  # ---- Trigger apply or destroy ----
  trigger-apply:
    needs: plan
    if: github.event.inputs.do_destroy != 'true'
    permissions:
      id-token: write
      contents: write
    uses: ./.github/workflows/terraform-apply.yml
    with:
      plan_artifact: terraform-plan

  trigger-destroy:
    needs: plan
    if: github.event.inputs.do_destroy == 'true'
    permissions:
      id-token: write
      contents: write
    uses: ./.github/workflows/terraform-delete.yml
    with:
      plan_artifact: terraform-destroy-plan
