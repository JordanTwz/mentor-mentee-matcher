name: Terraform Destroy

on:
  workflow_call:
    inputs:
      plan_artifact:
        type: string
        required: true
        description: "Name of the destroy plan artifact to apply"
  workflow_dispatch:
    inputs:
      plan_artifact:
        type: string
        required: true
        description: "Name of the destroy plan artifact to apply"

jobs:
  destroy:
    runs-on: ubuntu-latest
    environment: production  # requires approval
    permissions:
      id-token: write
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.13.5"

      - name: AWS OIDC Auth
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::368339042148:role/asp_proj-terraform-deploy
          aws-region: ap-southeast-1

      - name: Get ECS Cluster and Service Names
        id: get-ecs-info
        run: |
          CLUSTER_NAME=$(aws ecs list-clusters --region ap-southeast-1 --query 'clusterArns[0]' --output text | awk -F'/' '{print $NF}')
          SERVICE_NAME=$(aws ecs list-services --cluster $CLUSTER_NAME --region ap-southeast-1 --query 'serviceArns[0]' --output text | awk -F'/' '{print $NF}')
          echo "cluster_name=$CLUSTER_NAME" >> $GITHUB_OUTPUT
          echo "service_name=$SERVICE_NAME" >> $GITHUB_OUTPUT
          echo "Found ECS Cluster: $CLUSTER_NAME"
          echo "Found ECS Service: $SERVICE_NAME"

      - name: Scale ECS Service to Zero
        run: |
          aws ecs update-service \
            --cluster ${{ steps.get-ecs-info.outputs.cluster_name }} \
            --service ${{ steps.get-ecs-info.outputs.service_name }} \
            --desired-count 0 \
            --region ap-southeast-1
          echo "Scaled ECS service to 0 tasks"

      - name: Wait for Tasks to Stop
        run: |
          echo "Waiting for all tasks to stop..."
          aws ecs wait services-stable \
            --cluster ${{ steps.get-ecs-info.outputs.cluster_name }} \
            --services ${{ steps.get-ecs-info.outputs.service_name }} \
            --region ap-southeast-1
          echo "All tasks have stopped"

      - name: Delete Images from ECR
        run: |
          REPOSITORIES=$(aws ecr describe-repositories --region ap-southeast-1 --query 'repositories[*].repositoryName' --output text)
          for REPO in $REPOSITORIES; do
            echo "Processing repository: $REPO"
            IMAGE_IDS=$(aws ecr list-images --repository-name $REPO --region ap-southeast-1 --query 'imageIds[*]' --output json)
            if [ "$IMAGE_IDS" != "[]" ]; then
              aws ecr batch-delete-image \
                --repository-name $REPO \
                --image-ids "$IMAGE_IDS" \
                --region ap-southeast-1
              echo "Deleted images from $REPO"
            else
              echo "No images found in $REPO"
            fi
          done

      - name: Download Destroy Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.plan_artifact }}
          path: terraform/

      - name: Terraform Init
        working-directory: terraform
        run: terraform init -input=false

      - name: Terraform Destroy (Apply Destroy Plan)
        working-directory: terraform
        run: terraform apply -input=false tfdestroy

      - name: Notify Success
        if: success()
        run: echo "Terraform destroy completed successfully!"

      - name: Notify Failure
        if: failure()
        run: |
          echo "Terraform destroy failed!"
          exit 1
