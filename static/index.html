<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mentor-Mentee Matcher</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .data-row { cursor: pointer; }
    .detail-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    .detail-row td { padding: 0; border-top: 0; }
  </style>
</head>
<body>
  <div class="container my-5">
    <h1 class="mb-4">Mentor-Mentee Matcher</h1>

    <form id="matchForm">
      <div class="row g-3 align-items-end">
        <div class="col-md-5">
          <label for="mentorFile" class="form-label">Mentor Excel File</label>
          <input type="file" id="mentorFile" class="form-control" accept=".xlsx">
        </div>
        <div class="col-md-5">
          <label for="menteeFile" class="form-label">Mentee Excel File</label>
          <input type="file" id="menteeFile" class="form-control" accept=".xlsx">
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-primary w-100">Run Matching</button>
        </div>
      </div>
    </form>

    <div id="filters" class="mt-4 p-3 border rounded">
      <h5>Filters</h5>
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="filterDept">
        <label class="form-check-label" for="filterDept">Department Match</label>
      </div>
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="filterIndustry">
        <label class="form-check-label" for="filterIndustry">Industry Match</label>
      </div>
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="filterJobRole">
        <label class="form-check-label" for="filterJobRole">Job Role Match</label>
      </div>
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="filterPersonal">
        <label class="form-check-label" for="filterPersonal">Personal Interest Match</label>
      </div>
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="filterOptional">
        <label class="form-check-label" for="filterOptional">Keyword Match</label>
      </div>
    </div>

    <div id="result" class="mt-3"></div>
  </div>

  <script>
    const form = document.getElementById('matchForm');
    const resultDiv = document.getElementById('result');

    form.addEventListener('submit', async e => {
      e.preventDefault();
      const mf = document.getElementById('mentorFile').files[0];
      const tf = document.getElementById('menteeFile').files[0];
      if (!mf || !tf) return alert('Please upload both files.');
      const fd = new FormData();
      fd.append('mentors', mf);
      fd.append('mentees', tf);
      try {
        const res = await fetch('/api/match', { method: 'POST', body: fd });
        const json = await res.json();
        if (!res.ok) throw new Error(json.error || 'Server error');
        renderTable(json.matches);
        attachFilterListeners();
        applyFilters();
      } catch (err) {
        resultDiv.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
      }
    });

    function renderTable(data) {
      let html = `<h2>Results</h2><table id="matchTable" class="table table-striped"><thead>` +
                 `<tr><th>#</th><th>Mentor</th><th>Mentee</th><th>Total Score</th></tr>` +
                 `</thead><tbody>`;
      data.forEach((r,i) => {
        html += `<tr class="data-row" data-index="${i}" data-dept="${r.departmentScore}" ` +
                `data-industry="${r.industryScore}" data-job="${r.jobRoleScore}" ` +
                `data-personal="${r.personalScore}" data-optional="${r.optionalScore}">` +
                `<td>${i+1}</td><td>${r.mentor}</td><td>${r.mentee}</td><td>${r.totalScore}</td></tr>`;
        html += `<tr class="detail-row"><td colspan="4"><div class="detail-content">` +
                `<strong>Department:</strong> ${r.departmentDetail}<br>` +
                `<strong>Industry:</strong> ${r.industryDetails.join(', ')}<br>` +
                `<strong>Job Role:</strong> ${r.jobDetail}<br>` +
                `<strong>Personal Interests:</strong> ${r.personalDetails.join(', ')}<br>` +
                `<strong>Keywords:</strong> ${r.optionalDetails.join(', ')}` +
                `</div></td></tr>`;
      });
      html += `</tbody></table>`;
      resultDiv.innerHTML = html;
      attachRowListeners();
    }

    function attachRowListeners() {
      document.querySelectorAll('.data-row').forEach(row => {
        row.addEventListener('click', () => {
          const idx = row.dataset.index;
          const content = document.querySelector(`.detail-row:nth-of-type(${2*idx+2}) .detail-content`);
          if (!content) return;
          if (content.style.maxHeight && content.style.maxHeight !== '0px') {
            content.style.maxHeight = '0';
          } else {
            content.style.maxHeight = content.scrollHeight + 'px';
          }
        });
      });
    }

    function applyFilters() {
      const fDept = document.getElementById('filterDept').checked;
      const fInd = document.getElementById('filterIndustry').checked;
      const fJob = document.getElementById('filterJobRole').checked;
      const fPers = document.getElementById('filterPersonal').checked;
      const fOpt = document.getElementById('filterOptional').checked;
      document.querySelectorAll('#matchTable tbody tr.data-row').forEach((row,i) => {
        const d = +row.dataset.dept;
        const ind = +row.dataset.industry;
        const j = +row.dataset.job;
        const p = +row.dataset.personal;
        const o = +row.dataset.optional;
        let visible = true;
        if (fDept && d===0) visible = false;
        if (fInd && ind===0) visible = false;
        if (fJob && j===0) visible = false;
        if (fPers && p===0) visible = false;
        if (fOpt && o===0) visible = false;
        row.style.display = visible ? 'table-row' : 'none';
        const detailRow = row.nextElementSibling;
        if (detailRow && detailRow.classList.contains('detail-row')) {
          detailRow.style.display = visible ? 'table-row' : 'none';
          if (!visible) {
            const content = detailRow.querySelector('.detail-content');
            content.style.maxHeight = '0';
          }
        }
      });
    }

    function attachFilterListeners() {
      ['filterDept','filterIndustry','filterJobRole','filterPersonal','filterOptional']
        .forEach(id => document.getElementById(id).addEventListener('change', applyFilters));
    }
  </script>
</body>
</html>